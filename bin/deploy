#!/usr/bin/php

<?php

$environment = $argv[1];
$projectDir = dirname(__DIR__);
$configFile = "${projectDir}/infra/gcp/config.json";

if (!file_exists($configFile)) {
    throw new Exception("config file does not exist in path: ${configPath}");
}

/**
 * Configuration
 */

$config = json_decode(file_get_contents($configFile), true)[$environment];
$commitHashShort = shell_exec("git rev-parse --short HEAD");

/**
 * Utilities
 */

function authenticateDocker($serviceAccount, $serviceAccountKey) {
    shell_exec(sprintf("gcloud auth activate-service-account %s --key-file=%s", $serviceAccount, $serviceAccountKey));
    shell_exec("gcloud auth configure-docker us-docker.pkg.dev");
}

function buildDockerImage($image) {
    shell_exec(sprintf("docker build -t %s -f DockerFile .", $image));
    shell_exec(sprintf("docker push %s", $image));
}

function terraformApply($dir, $image) {
    shell_exec(sprintf("terraform -chdir=%s init", $dir));
    shell_exec(sprintf("terraform -chdir=%s apply -var %s -auto-approve", $dir, "app_image=${image}"));
}

/**
 * Execution
 */

authenticateDocker($config['serviceAccount'], $config['serviceAccountKey']);
