#!/usr/bin/php

<?php

$environment = $argv[1];
$projectDir = dirname(__DIR__);
$configFile = "${projectDir}/infra/gcp/config.json";

if (!file_exists($configFile)) {
    throw new Exception("config file does not exist in path: ${configPath}");
}

/**
 * Configuration
 */

$config = json_decode(file_get_contents($configFile), true)[$environment];

/**
 * Utilities
 */

function formatString($str) {
    return trim(preg_replace('/\s+/', ' ', $str));
}

function authenticateDocker($serviceAccount, $serviceAccountKey) {
    shell_exec(formatString("gcloud auth activate-service-account ${serviceAccount} --key-file=${serviceAccountKey} --quiet"));
    shell_exec(formatString("gcloud auth configure-docker us-docker.pkg.dev --quiet"));
}

function buildDockerImage($image) {
    shell_exec(formatString("docker build -t ${image} -f DockerFile ."));
    shell_exec(formatString("docker push ${image}"));
}

function terraformApply($dir, $image) {
    shell_exec(formatString("terraform -chdir=${dir} init"));
    shell_exec(formatString("terraform -chdir=${dir} apply -var app_image=${image} -auto-approve"));
}

/**
 * Execution
 */

$commitHash = shell_exec("git rev-parse --short HEAD");
$serviceAccountKeyFile = "${projectDir}/infra/gcp/credentials/${config['serviceAccountKey']}";
$terraformDir = "${projectDir}/infra/gcp/terraform";
$image = "us-docker.pkg.dev/outside-playground-300111/cloudrun-deployment/api:${commitHash}";

authenticateDocker($config['serviceAccount'], $serviceAccountKeyFile);
buildDockerImage($image);
terraformApply($terraformDir, $image);
